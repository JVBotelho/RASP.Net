print("DEBUG: Script iniciando...") # <--- Adicione isso na linha 1
import grpc
import sys
import os

# Add current directory to path to import generated stubs
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Import generated modules (created by the build script)
# Note: Names depend on how protoc generates files.
# Assuming library.proto generates library_pb2.py and library_pb2_grpc.py
try:
    import library_pb2
    import library_pb2_grpc
except ImportError:
    print("❌ Error: Compiled proto files not found.")
    print("Run: bash generate_protos.sh")
    sys.exit(1)

def run_exploit(target):
    print(f"[*] Connecting to target: {target}")
    
    # Create insecure channel (for local PoC only)
    with grpc.insecure_channel(target) as channel:
        stub = library_pb2_grpc.LibraryStub(channel)
        
        # --- SCENARIO 1: SQL Injection Payload ---
        # This payload matches the regex defined in RegexDetectionEngine
        payload = "' OR '1'='1"
        print(f"[*] Sending malicious payload: \"{payload}\"")
        
        try:
            response = stub.CreateBook(library_pb2.CreateBookRequest(
                title=payload, # <--- INJECTION POINT
                author="Hacker",
                publication_year=2025,
                pages=100,
                total_copies=10
            ))
            print("❌ FAILURE: Server accepted the payload! RASP did not block.")
            print(f"   Response: ID={response.id}, Title={response.title}")
            return False
            
        except grpc.RpcError as e:
            # Check if blocked by RASP (PermissionDenied)
            if e.code() == grpc.StatusCode.PERMISSION_DENIED:
                print("✅ SUCCESS: RASP blocked the attack!")
                print(f"   Status: {e.code()}")
                print(f"   Details: {e.details()}")
                return True
            else:
                print(f"⚠️ UNEXPECTED ERROR: Server returned an error, but not the expected block.")
                print(f"   Status: {e.code()}")
                print(f"   Details: {e.details()}")
                return False

if __name__ == '__main__':
    # Default target: localhost:5001 (gRPC backend)
    # Adjust if running via Docker or another port
    target_url = 'localhost:5001' 
    if len(sys.argv) > 1:
        target_url = sys.argv[1]
        
    success = run_exploit(target_url)
    
    if success:
        sys.exit(0)
    else:
        sys.exit(1)